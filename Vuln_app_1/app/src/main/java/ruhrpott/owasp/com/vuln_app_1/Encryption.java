package ruhrpott.owasp.com.vuln_app_1;

import android.content.Context;
import android.os.Bundle;
import android.support.v4.app.Fragment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import android.util.Base64;


public class Encryption extends Fragment{

    public static Encryption newInstance() {
        Encryption fragment = new Encryption();
        return fragment;
    }

    public Encryption() {

    }

    Button ClickMe;

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        View rootView = inflater.inflate(R.layout.fragment_encryption, container, false);

        ClickMe = (Button) rootView.findViewById(R.id.button);
        ClickMe.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                File file = new File(getActivity().getFilesDir() +"/config.txt");
                if(file.exists()) {
                    TextView text = (TextView) getView().findViewById(R.id.textView13);

                    String content = new String(Base64.decode(readFile("config.txt",getActivity()),Base64.NO_PADDING|Base64.NO_WRAP));
                    text.setText("Decrypted Text: "+secureEncrypt(content,getActivity()));
                }
                else {
                    writeToFile("AxoYZ2hsHi1VVSE5MEdbJG0LQVA+PTZATGw/NldTPw",getActivity());
                    TextView text = (TextView) getView().findViewById(R.id.textView13);
                    text.setText("File written to: "+getActivity().getFilesDir() +"/config.txt");

                }
            }
        });
        return rootView;
    }

    private void writeToFile (String data, Context context) {
        try {
        OutputStreamWriter outputStreamWriter = new OutputStreamWriter(context.openFileOutput("config.txt",context.MODE_PRIVATE));
        outputStreamWriter.write(data);
        outputStreamWriter.close();;
        } catch(IOException e) {
        }
    }

    private String secureEncrypt(String text, Context context) {

        String security =  android.os.Build.ID;
        if(security == "") {
            security = "jdmc94ÃŸ2ksjderpq";
        }
        StringBuilder sb = new StringBuilder();
        for(int i=0; i<text.length();i++) {
            sb.append((char) (text.charAt(i) ^ security.charAt(i % (security.length()-1))));
        }
        return sb.toString();
    }

    private String readFile(String lpath, Context context) {
        StringBuilder sb = new StringBuilder();
                try {
                    BufferedReader reader = new BufferedReader(new InputStreamReader(context.openFileInput(lpath)));
                    try {
                        String myLine = reader.readLine();
                        while(myLine != null) {
                            sb.append(myLine);
                            myLine = reader.readLine();
                        }
                        reader.close();

                    } catch (IOException e) {
                    }
                } catch(FileNotFoundException e) {
                }
        return sb.toString();
    }
}